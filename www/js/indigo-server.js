// Generated by CoffeeScript 1.7.1
var IndigoServer;

IndigoServer = (function() {
  function IndigoServer(serverURL) {
    this.serverURL = serverURL;
    this.ACTIONS_URI = this.serverURL + "/actions.json";
  }

  IndigoServer.prototype.setReadyCallback = function(dataReadyCallback) {
    this.dataReadyCallback = dataReadyCallback;
  };

  IndigoServer.prototype.getActionGroups = function() {
    $.ajax(this.ACTIONS_URI, {
      type: "GET",
      dataType: "json",
      crossDomain: true,
      success: (function(_this) {
        return function(data, textStatus, jqXHR) {
          _this.scenes = _this.getScenes(data);
          _this.scenes.sort(_this.sortByRoomName);
          _this.dataReadyCallback(_this.scenes);
          console.log("Indigo data = " + JSON.stringify(_this.scenes));
        };
      })(this)
    });
  };

  IndigoServer.prototype.sortByRoomName = function(a, b) {
    if (a.groupName < b.groupName) {
      return -1;
    }
    if (a.groupName > b.groupName) {
      return 1;
    }
    return 0;
  };

  IndigoServer.prototype.getScenes = function(data, rooms) {
    var actionName, indigoScene, indigoScenes, name, roomName, scene, scenes, _i, _len;
    indigoScenes = data;
    scenes = [];
    for (_i = 0, _len = indigoScenes.length; _i < _len; _i++) {
      indigoScene = indigoScenes[_i];
      name = indigoScene.name.split(" - ");
      actionName = indigoScene.name;
      if (name.length > 1) {
        roomName = name[0].trim();
        actionName = name[1].trim();
      }
      scene = {
        actionNum: "",
        actionName: roomName + " " + actionName,
        groupName: roomName,
        actionUrl: this.serverURL + "/actions/" + indigoScene.nameURLEncoded + "?_method=execute"
      };
      scenes.push(scene);
    }
    return scenes;
  };

  IndigoServer.prototype.getActionGroupsXML = function() {
    var matchRe;
    matchRe = /<action\b[^>]href="(.*?).xml"[^>]*>(.*?)<\/action>/;
    return $.ajax(this.ACTIONS_URI, {
      type: "GET",
      dataType: "xml",
      crossDomain: true,
      success: (function(_this) {
        return function(data, textStatus, jqXHR) {
          var action, actionDict, actions, bLoop, pos, respText;
          bLoop = true;
          respText = jqXHR.responseText;
          actions = [];
          console.log("Got from Indigo " + jqXHR.responseText);
          while (bLoop) {
            action = matchRe.exec(respText);
            if (action === null) {
              break;
            }
            pos = respText.search(matchRe);
            if (pos === -1) {
              break;
            }
            respText = respText.substring(pos + action[0].length);
            actionDict = {
              actionNum: "",
              actionName: action[2],
              groupName: "",
              actionUrl: _this.serverURL + action[1] + "?_method=execute"
            };
            actions[actions.length] = actionDict;
            console.log("Adding action " + JSON.stringify(actionDict));
          }
          return _this.dataReadyCallback(actions);
        };
      })(this)
    });
  };

  return IndigoServer;

})();
