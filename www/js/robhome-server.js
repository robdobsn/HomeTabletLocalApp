// Generated by CoffeeScript 2.7.0
(function() {
  App.RobHomeServer = class RobHomeServer {
    constructor(manager, serverDef, dataReadyCallback) {
      this.manager = manager;
      this.serverDef = serverDef;
      this.dataReadyCallback = dataReadyCallback;
      this.ACTIONS_URI = this.serverDef.url + "/scenes";
      this.numRefreshFailuresSinceSuccess = 0;
      this.firstRefreshAfterFailSecs = 10;
      this.nextRefreshesAfterFailSecs = 60;
      return;
    }

    setReadyCallback(dataReadyCallback) {
      this.dataReadyCallback = dataReadyCallback;
    }

    reqActions() {
      console.log("robhome-server Requesting RobHomeServer data from " + this.ACTIONS_URI);
      $.ajax(this.ACTIONS_URI, {
        type: "GET",
        dataType: "json",
        crossDomain: true,
        success: (data, textStatus, jqXHR) => {
          this.processRecvdActions(data, true);
          this.numRefreshFailuresSinceSuccess = 0;
          App.LocalStorage.set(this.ACTIONS_URI, data);
        },
        error: (jqXHR, textStatus, errorThrown) => {
          var storedData;
          console.log("robhome-server " + " RobHomeServer AjaxFail Status= " + textStatus + " URL= " + this.ACTIONS_URI + " Error= " + errorThrown);
          App.LocalStorage.logEvent("RobLog", "AjaxFail Status= " + textStatus + " URL= " + this.ACTIONS_URI + " Error= " + errorThrown);
          this.numRefreshFailuresSinceSuccess++;
          setTimeout(() => {
            return this.getActionGroups;
          }, (this.numRefreshFailuresSinceSuccess === 1 ? this.firstRefreshAfterFailSecs * 1000 : this.nextRefreshesAfterFailSecs * 1000));
          // Use stored data if available
          storedData = App.LocalStorage.get(this.ACTIONS_URI);
          console.log("robhome-server Getting data stored for " + this.ACTIONS_URI + " result = " + storedData);
          if (storedData != null) {
            // console.log "Using stored data" + JSON.stringify(storedData)
            console.log("robhome-server Using stored data for " + this.ACTIONS_URI);
            this.processRecvdActions(storedData, false);
          }
        }
      });
    }

    processRecvdActions(data, fromURI) {
      this.scenes = this.getScenes(data);
      this.scenes.sort(this.sortByRoomName);
      this.dataReadyCallback(this.serverDef.name, this.scenes);
      return console.log("robhome-server processRecvdActions from " + (fromURI ? this.ACTIONS_URI : "STORAGE") + " #scenes " + this.scenes.length);
    }

    sortByRoomName(a, b) {
      if (a.groupName < b.groupName) {
        return -1;
      }
      if (a.groupName > b.groupName) {
        return 1;
      }
      return 0;
    }

    getScenes(data, rooms) {
      var actionName, i, len, scene, scenes, serverScene, serverScenes;
      scenes = [];
      serverScenes = data.scenes;
      if (serverScenes != null) {
        for (i = 0, len = serverScenes.length; i < len; i++) {
          serverScene = serverScenes[i];
          actionName = serverScene.room + " - " + serverScene.nom;
          // console.log "robhome-server serverScene = " + JSON.stringify(serverScene)
          if ("urls" in serverScene && "room" in serverScene && "nom" in serverScene) {
            scene = {
              actionNum: "",
              actionName: serverScene.room + " " + serverScene.nom,
              groupName: serverScene.room,
              actionUrl: serverScene.urls.join(";"),
              iconName: this.manager.getIconFromActionName(actionName, this.serverDef.iconAliasing)
            };
            scenes.push(scene);
          } else {
            console.warn("robhome-server serverScene urls/nom/room missing = " + JSON.stringify(serverScene));
          }
        }
      }
      // console.log "robhome-server RobHomeServer scene " + JSON.stringify(scene)
      return scenes;
    }

  };

}).call(this);

//# sourceMappingURL=robhome-server.js.map
