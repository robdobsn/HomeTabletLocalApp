{
  "version": 3,
  "file": "indigo-server.js",
  "sourceRoot": "..\\..",
  "sources": [
    "www\\js\\indigo-server.coffee"
  ],
  "names": [],
  "mappings": ";AAAA;EAAM,GAAG,CAAC,eAAV,MAAA,aAAA;IACC,WAAa,QAAA,WAAA,mBAAA,CAAA;MAAC,IAAC,CAAA;MAAS,IAAC,CAAA;MAAW,IAAC,CAAA;MACpC,IAAC,CAAA,WAAD,GAAe,IAAC,CAAA,SAAS,CAAC,GAAX,GAAiB;MAChC,IAAC,CAAA,8BAAD,GAAkC;MAClC,IAAC,CAAA,yBAAD,GAA6B;MAC7B,IAAC,CAAA,0BAAD,GAA8B;AAC9B;IALY;;IAOb,gBAAkB,kBAAA,CAAA;MAAC,IAAC,CAAA;IAAF;;IAGlB,UAAY,CAAA,CAAA;MACX,OAAO,CAAC,GAAR,CAAY,8BAAA,GAAiC,IAAC,CAAA,WAA9C;MACA,CAAC,CAAC,IAAF,CAAO,IAAC,CAAA,WAAR,EACC;QAAA,IAAA,EAAM,KAAN;QACA,QAAA,EAAU,MADV;QAEA,WAAA,EAAa,IAFb;QAGA,OAAA,EAAS,CAAC,IAAD,EAAO,UAAP,EAAmB,KAAnB,CAAA,GAAA;UACR,IAAC,CAAA,mBAAD,CAAqB,IAArB,EAAJ;;UAEI,OAAO,CAAC,GAAR,CAAY,4BAAA,GAA+B,IAAC,CAAA,WAA5C;UACA,IAAC,CAAA,8BAAD,GAAkC;UAClC,GAAG,CAAC,YAAY,CAAC,GAAjB,CAAqB,IAAC,CAAA,WAAtB,EAAmC,IAAnC;QALQ,CAHT;QAUA,KAAA,EAAO,CAAC,KAAD,EAAQ,UAAR,EAAoB,WAApB,CAAA,GAAA;AACV,cAAA;UAAI,GAAG,CAAC,YAAY,CAAC,QAAjB,CAA0B,QAA1B,EAAoC,mBAAA,GAAsB,UAAtB,GAAmC,QAAnC,GAA8C,IAAC,CAAA,WAA/C,GAA6D,UAA7D,GAA0E,WAA9G;UACA,IAAC,CAAA,8BAAD;UACA,UAAA,CAAW,CAAA,CAAA,GAAA;mBACV,IAAC,CAAA;UADS,CAAX,EAEE,CAAI,IAAC,CAAA,8BAAD,KAAmC,CAAtC,GAA6C,IAAC,CAAA,yBAAD,GAA6B,IAA1E,GAAoF,IAAC,CAAA,0BAAD,GAA8B,IAAnH,CAFF,EAFJ;;UAMI,UAAA,GAAa,GAAG,CAAC,YAAY,CAAC,GAAjB,CAAqB,IAAC,CAAA,WAAtB,EANjB;;UAQI,IAAG,kBAAH;;YAEC,OAAO,CAAC,GAAR,CAAY,wBAAA,GAA2B,IAAC,CAAA,WAAxC;YACA,IAAC,CAAA,mBAAD,CAAqB,UAArB,EAHD;;QATM;MAVP,CADD;IAFW;;IA6BZ,mBAAqB,CAAC,IAAD,CAAA;MACpB,IAAC,CAAA,MAAD,GAAU,IAAC,CAAA,SAAD,CAAW,IAAX;MACV,IAAC,CAAA,MAAM,CAAC,IAAR,CAAa,IAAC,CAAA,cAAd;aACA,IAAC,CAAA,iBAAD,CAAmB,IAAC,CAAA,SAAS,CAAC,IAA9B,EAAoC,IAAC,CAAA,MAArC;IAHoB;;IAKrB,cAAgB,CAAC,CAAD,EAAI,CAAJ,CAAA;MACf,IAAG,CAAC,CAAC,SAAF,GAAc,CAAC,CAAC,SAAnB;AAAkC,eAAO,CAAC,EAA1C;;MACA,IAAG,CAAC,CAAC,SAAF,GAAc,CAAC,CAAC,SAAnB;AAAkC,eAAO,EAAzC;;AACA,aAAO;IAHQ;;IAKhB,SAAW,CAAC,IAAD,EAAO,KAAP,CAAA;AACZ,UAAA,UAAA,EAAA,CAAA,EAAA,WAAA,EAAA,YAAA,EAAA,GAAA,EAAA,IAAA,EAAA,QAAA,EAAA,KAAA,EAAA;MAAE,YAAA,GAAe;MACf,MAAA,GAAS;MACT,KAAA,8CAAA;;QACC,IAAA,GAAO,WAAW,CAAC,IAAI,CAAC,KAAjB,CAAuB,KAAvB;QACP,UAAA,GAAa,WAAW,CAAC;QACzB,IAAG,IAAI,CAAC,MAAL,GAAc,CAAjB;UACC,QAAA,GAAW,IAAI,CAAC,CAAD,CAAG,CAAC,IAAR,CAAA;UACX,UAAA,GAAa,IAAI,CAAC,CAAD,CAAG,CAAC,IAAR,CAAA,EAFd;;QAGA,KAAA,GACC;UAAA,SAAA,EAAW,EAAX;UACA,UAAA,EAAY,QAAA,GAAW,GAAX,GAAiB,UAD7B;UAEA,SAAA,EAAW,QAFX;UAGA,SAAA,EAAW,IAAC,CAAA,SAAS,CAAC,GAAX,GAAiB,WAAjB,GAA+B,WAAW,CAAC,cAA3C,GAA4D,kBAHvE;UAIA,QAAA,EAAU,IAAC,CAAA,OAAO,CAAC,qBAAT,CAA+B,UAA/B,EAA2C,IAAC,CAAA,SAAS,CAAC,YAAtD;QAJV;QAKD,MAAM,CAAC,IAAP,CAAY,KAAZ;MAZD;AAaA,aAAO;IAhBG;;IAmBX,kBAAoB,CAAA,CAAA;AACrB,UAAA;MAAE,OAAA,GAAU;MAGV,CAAC,CAAC,IAAF,CAAO,IAAC,CAAA,WAAR,EACC;QAAA,IAAA,EAAM,KAAN;QACA,QAAA,EAAU,KADV;QAEA,WAAA,EAAa,IAFb;QAGA,OAAA,EAAS,CAAC,IAAD,EAAO,UAAP,EAAmB,KAAnB,CAAA,GAAA;AACZ,cAAA,MAAA,EAAA,UAAA,EAAA,OAAA,EAAA,KAAA,EAAA,GAAA,EAAA;UAAI,KAAA,GAAQ;UACR,QAAA,GAAW,KAAK,CAAC;UACjB,OAAA,GAAU;UACV,OAAO,CAAC,GAAR,CAAY,kBAAA,GAAqB,KAAK,CAAC,YAAvC;AACA,iBAAM,KAAN;YACC,MAAA,GAAS,OAAO,CAAC,IAAR,CAAa,QAAb;YACT,IAAG,MAAA,KAAU,IAAb;AAAuB,oBAAvB;;YACA,GAAA,GAAM,QAAQ,CAAC,MAAT,CAAgB,OAAhB;YACN,IAAG,GAAA,KAAO,CAAC,CAAX;AAAkB,oBAAlB;;YACA,QAAA,GAAW,QAAQ,CAAC,SAAT,CAAmB,GAAA,GAAI,MAAM,CAAC,CAAD,CAAG,CAAC,MAAjC;YACX,UAAA,GAAa;cAAE,SAAA,EAAW,EAAb;cAAiB,UAAA,EAAY,MAAM,CAAC,CAAD,CAAnC;cAAwC,SAAA,EAAW,EAAnD;cAAuD,SAAA,EAAW,IAAC,CAAA,SAAS,CAAC,GAAX,GAAiB,MAAM,CAAC,CAAD,CAAvB,GAA6B;YAA/F;YACb,OAAO,CAAC,OAAO,CAAC,MAAT,CAAP,GAA0B;YAC1B,OAAO,CAAC,GAAR,CAAY,gBAAA,GAAmB,IAAI,CAAC,SAAL,CAAe,UAAf,CAA/B;UARD;iBASA,IAAC,CAAA,iBAAD,CAAmB,IAAC,CAAA,SAAS,CAAC,IAA9B,EAAoC,OAApC;QAdQ;MAHT,CADD;IAJmB;;EArErB;AAAA",
  "sourcesContent": [
    "class App.IndigoServer\r\n\tconstructor: (@manager, @serverDef, @dataReadyCallback) ->\r\n\t\t@ACTIONS_URI = @serverDef.url + \"/actions.json\"\r\n\t\t@numRefreshFailuresSinceSuccess = 0\r\n\t\t@firstRefreshAfterFailSecs = 10\r\n\t\t@nextRefreshesAfterFailSecs = 60\r\n\t\treturn\r\n\r\n\tsetReadyCallback: (@dataReadyCallback) ->\r\n\t\treturn\r\n\r\n\treqActions: ->\r\n\t\tconsole.log \"Requesting Indigo data from \" + @ACTIONS_URI\r\n\t\t$.ajax @ACTIONS_URI,\r\n\t\t\ttype: \"GET\"\r\n\t\t\tdataType: \"json\"\r\n\t\t\tcrossDomain: true\r\n\t\t\tsuccess: (data, textStatus, jqXHR) =>\r\n\t\t\t\t@processRecvdActions(data)\r\n\t\t\t\t# console.log \"Indigo data = \" + JSON.stringify(@scenes)\r\n\t\t\t\tconsole.log \"Received Indigo data from \" + @ACTIONS_URI\r\n\t\t\t\t@numRefreshFailuresSinceSuccess = 0\r\n\t\t\t\tApp.LocalStorage.set(@ACTIONS_URI, data)\r\n\t\t\t\treturn\r\n\t\t\terror: (jqXHR, textStatus, errorThrown) =>\r\n\t\t\t\tApp.LocalStorage.logEvent(\"IndLog\", \"AjaxFail Status= \" + textStatus + \" URL= \" + @ACTIONS_URI + \" Error= \" + errorThrown)\r\n\t\t\t\t@numRefreshFailuresSinceSuccess++\r\n\t\t\t\tsetTimeout =>\r\n\t\t\t\t\t@getActionGroups\r\n\t\t\t\t, (if @numRefreshFailuresSinceSuccess is 1 then @firstRefreshAfterFailSecs * 1000 else @nextRefreshesAfterFailSecs * 1000)\r\n\t\t\t\t# Use stored data if available\r\n\t\t\t\tstoredData = App.LocalStorage.get(@ACTIONS_URI)\r\n\t\t\t\t# console.log \"Getting data stored for \" + @ACTIONS_URI + \" result = \" + storedData\r\n\t\t\t\tif storedData?\r\n\t\t\t\t\t# console.log \"Using stored data\" + JSON.stringify(storedData)\r\n\t\t\t\t\tconsole.log \"Using stored data for \" + @ACTIONS_URI\r\n\t\t\t\t\t@processRecvdActions(storedData)\r\n\t\t\t\treturn\r\n\t\treturn\r\n\r\n\tprocessRecvdActions: (data) ->\r\n\t\t@scenes = @getScenes(data)\r\n\t\t@scenes.sort @sortByRoomName\r\n\t\t@dataReadyCallback(@serverDef.name, @scenes)\r\n\r\n\tsortByRoomName: (a, b) ->\r\n\t\tif a.groupName < b.groupName then return -1\r\n\t\tif a.groupName > b.groupName then return 1\r\n\t\treturn 0\r\n\r\n\tgetScenes: (data, rooms) ->\r\n\t\tindigoScenes = data\r\n\t\tscenes = []\r\n\t\tfor indigoScene in indigoScenes\r\n\t\t\tname = indigoScene.name.split(\" - \")\r\n\t\t\tactionName = indigoScene.name\r\n\t\t\tif name.length > 1\r\n\t\t\t\troomName = name[0].trim()\r\n\t\t\t\tactionName = name[1].trim()\r\n\t\t\tscene = \r\n\t\t\t\tactionNum: \"\"\r\n\t\t\t\tactionName: roomName + \" \" + actionName\r\n\t\t\t\tgroupName: roomName\r\n\t\t\t\tactionUrl: @serverDef.url + \"/actions/\" + indigoScene.nameURLEncoded + \"?_method=execute\"\r\n\t\t\t\ticonName: @manager.getIconFromActionName(actionName, @serverDef.iconAliasing)\r\n\t\t\tscenes.push(scene)\r\n\t\treturn scenes\r\n\r\n\r\n\tgetActionGroupsXML: ->\r\n\t\tmatchRe = ///\r\n\t\t\t<action\\b[^>]href=\"(.*?).xml\"[^>]*>(.*?)</action>\r\n\t\t\t///\r\n\t\t$.ajax @ACTIONS_URI,\r\n\t\t\ttype: \"GET\"\r\n\t\t\tdataType: \"xml\"\r\n\t\t\tcrossDomain: true\r\n\t\t\tsuccess: (data, textStatus, jqXHR) =>\r\n\t\t\t\tbLoop = true\r\n\t\t\t\trespText = jqXHR.responseText\r\n\t\t\t\tactions = []\r\n\t\t\t\tconsole.log \"Got from Indigo \" + jqXHR.responseText\r\n\t\t\t\twhile bLoop\r\n\t\t\t\t\taction = matchRe.exec(respText)\r\n\t\t\t\t\tif action is null then break\r\n\t\t\t\t\tpos = respText.search matchRe\r\n\t\t\t\t\tif pos is -1 then break\r\n\t\t\t\t\trespText = respText.substring(pos+action[0].length)\r\n\t\t\t\t\tactionDict = { actionNum: \"\", actionName: action[2], groupName: \"\", actionUrl: @serverDef.url + action[1] + \"?_method=execute\" }\r\n\t\t\t\t\tactions[actions.length] = actionDict\r\n\t\t\t\t\tconsole.log \"Adding action \" + JSON.stringify(actionDict)\r\n\t\t\t\t@dataReadyCallback(@serverDef.name, actions)\r\n\t\treturn\r\n\r\n"
  ]
}