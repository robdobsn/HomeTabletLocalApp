// Generated by CoffeeScript 1.7.1
var CalendarTile,
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

CalendarTile = (function(_super) {
  __extends(CalendarTile, _super);

  function CalendarTile(tileDef, calendarURL, calDayIndex) {
    this.calendarURL = calendarURL;
    this.calDayIndex = calDayIndex;
    CalendarTile.__super__.constructor.call(this, tileDef);
    this.shortDayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
    this.calLineCount = 0;
    this.calCharCount = 0;
    this.calMaxLineLen = 0;
    this.minutesBetweenCalendarRefreshes = 15;
    this.firstRefreshAfterFailSecs = 10;
    this.nextRefreshesAfterFailSecs = 60;
    this.numRefreshFailuresSinceSuccess = 0;
    return;
  }

  CalendarTile.prototype.addToDoc = function() {
    CalendarTile.__super__.addToDoc.call(this);
    this.setRefreshInterval(this.minutesBetweenCalendarRefreshes * 60, this.requestCalUpdate, true);
  };

  CalendarTile.prototype.requestCalUpdate = function() {
    var dateTimeNow;
    dateTimeNow = new Date();
    console.log("ReqCalUpdate at " + dateTimeNow.toTimeString() + " from " + this.calendarURL);
    $.ajax(this.calendarURL, {
      type: "GET",
      dataType: "text",
      crossDomain: true,
      success: (function(_this) {
        return function(data, textStatus, jqXHR) {
          var jsonData, jsonText;
          jsonText = jqXHR.responseText;
          jsonData = $.parseJSON(jsonText);
          _this.showCalendar(jsonData);
          _this.numRefreshFailuresSinceSuccess = 0;
        };
      })(this),
      error: (function(_this) {
        return function(jqXHR, textStatus, errorThrown) {
          LocalStorage.logEvent("CalLog", "AjaxFail Status = " + textStatus + " URL=" + _this.calendarURL + " Error= " + errorThrown);
          _this.numRefreshFailuresSinceSuccess++;
          setTimeout(function() {
            return _this.requestCalUpdate;
          }, (_this.numRefreshFailuresSinceSuccess === 1 ? _this.firstRefreshAfterFailSecs * 1000 : _this.nextRefreshesAfterFailSecs * 1000));
        };
      })(this)
    });
  };

  CalendarTile.prototype.showCalendar = function(jsonData) {
    var calTitle, event, newHtml, newLine, reqDate, reqDateStr, _i, _len, _ref;
    if (!("calEvents" in jsonData)) {
      return;
    }
    newHtml = "";
    reqDate = new Date();
    reqDate.setDate(reqDate.getDate() + this.calDayIndex);
    reqDateStr = this.toZeroPadStr(reqDate.getFullYear(), 4) + this.toZeroPadStr(reqDate.getMonth() + 1, 2) + this.toZeroPadStr(reqDate.getDate(), 2);
    calTitle = "Today";
    if (this.calDayIndex !== 0) {
      calTitle = this.shortDayNames[reqDate.getDay()];
    }
    this.calLineCount = 0;
    this.calCharCount = 0;
    this.calMaxLineLen = 0;
    _ref = jsonData["calEvents"];
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      event = _ref[_i];
      if (event["eventDate"] === reqDateStr) {
        this.calLineCount += 1;
        newLine = "<span class=\"sqCalEventStart\">" + event["eventTime"] + "</span>\n<span class=\"sqCalEventDur\"> (" + (this.formatDurationStr(event["duration"])) + ") </span>\n<span class=\"sqCalEventSummary\">" + event["summary"] + "</span>";
        newHtml += "<li class=\"sqCalEvent\">\n	" + newLine + "\n</li>";
        this.calCharCount += newLine.length;
        this.calMaxLineLen = this.calMaxLineLen < newLine.length ? newLine.length : this.calMaxLineLen;
      }
    }
    if (newHtml === "") {
      newHtml = "Nothing doing";
    }
    this.contents.html("<div class=\"sqCalTitle\">" + calTitle + "</div>\n<ul class=\"sqCalEvents\">\n	" + newHtml + "\n</ul>");
    this.recalculateFontScaling();
  };

  CalendarTile.prototype.toZeroPadStr = function(value, digits) {
    var s;
    s = "0000" + value;
    return s.substr(s.length - digits);
  };

  CalendarTile.prototype.reposition = function(posX, posY, sizeX, sizeY, fontScaling) {
    CalendarTile.__super__.reposition.call(this, posX, posY, sizeX, sizeY, fontScaling);
    this.recalculateFontScaling();
  };

  CalendarTile.prototype.calcTextWidth = function(text, fontSize, boxWidth) {
    if (this.fakeEl == null) {
      this.fakeEl = $("<span>").hide().appendTo(document.body);
    }
    this.fakeEl.text(text).css("font-size", fontSize);
    return this.fakeEl.width();
  };

  CalendarTile.prototype.findOptimumFontSize = function(optHeight, docElem, initScale, maxFontScale) {
    var availSize, calText, fontScale, i, sizeInc, textSize, _i;
    availSize = (optHeight ? this.sizeY : this.sizeX) * 0.9;
    calText = this.getElement(docElem);
    textSize = optHeight ? calText.height() : this.calcTextWidth(calText.text(), calText.css("font-size"));
    if (textSize == null) {
      return 1.0;
    }
    fontScale = optHeight ? availSize / textSize : initScale;
    fontScale = fontScale > maxFontScale ? maxFontScale : fontScale;
    this.setContentFontScaling(fontScale);
    sizeInc = 1.0;
    for (i = _i = 0; _i <= 6; i = ++_i) {
      calText = this.getElement(docElem);
      textSize = optHeight ? calText.height() : this.calcTextWidth(calText.text(), calText.css("font-size"));
      if (textSize == null) {
        return fontScale;
      }
      if (textSize > availSize) {
        fontScale = fontScale * (1 - (sizeInc / 2));
        this.setContentFontScaling(fontScale);
      } else if (textSize < (availSize * 0.75) && fontScale < maxFontScale) {
        fontScale = fontScale * (1 + sizeInc);
        this.setContentFontScaling(fontScale);
      } else {
        break;
      }
      sizeInc *= 0.5;
    }
    return fontScale;
  };

  CalendarTile.prototype.recalculateFontScaling = function() {
    var fontScale;
    if ((this.sizeX == null) || (this.sizeY == null) || (this.calLineCount === 0)) {
      return;
    }
    fontScale = this.findOptimumFontSize(true, ".sqCalEvents", 1.0, 2);
    this.setContentFontScaling(fontScale);
  };

  CalendarTile.prototype.formatDurationStr = function(val) {
    var days, dur, hrs, mins, outStr;
    dur = val.split(":");
    days = parseInt(dur[0]);
    hrs = parseInt(dur[1]);
    mins = parseInt(dur[2]);
    outStr = "";
    if (days === 0 && hrs !== 0 && mins === 30) {
      outStr = (hrs + 0.5) + "h";
    } else {
      outStr = days === 0 ? "" : days + "d";
      outStr += hrs === 0 ? "" : hrs + "h";
      outStr += mins === 0 ? "" : mins + "m";
    }
    return outStr;
  };

  return CalendarTile;

})(Tile);
