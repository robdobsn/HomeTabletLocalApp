// Generated by CoffeeScript 1.7.1
var TileTier;

TileTier = (function() {
  function TileTier(parentTag, tierName) {
    this.parentTag = parentTag;
    this.tierName = tierName;
    this.groups = [];
    this.groupCols = [];
    this.groupSepPixels = 0;
    this.groupTitlesTopMargin = 60;
    this.tileSepXPixels = 20;
    this.tileSepYPixels = 20;
    this.nextTileIdx = 0;
    this.tierId = "sqTier" + this.tierName;
    this.groupTitlesClass = "sqGroupTitles";
    this.groupTitlesTagLocator = "#" + this.tierId + " ." + this.groupTitlesClass;
    this.groupsClass = "sqGroups";
    this.groupsTagLocator = "#" + this.tierId + " ." + this.groupsClass;
    this.tilesAcross = 5;
  }

  TileTier.prototype.getTileTierSelector = function() {
    return this.groupsTagLocator + " .sqTileContainer";
  };

  TileTier.prototype.addToDom = function() {
    return $(this.parentTag).append("            <div id=\"" + this.tierId + "\" class=\"sqTier\">\n                <div class=\"" + this.groupTitlesClass + " snap\"/>\n                <div class=\"" + this.groupsClass + "\">\n    <div class=\"sqTileContainer\" style=\"width:3000px;display:block;zoom:1;\">\n    </div>\n</div>\n            </div>");
  };

  TileTier.prototype.removeAll = function() {
    this.clearTiles();
    return $("#" + this.tierId).remove();
  };

  TileTier.prototype.clearTiles = function() {
    var group, _i, _len, _ref, _results;
    _ref = this.groups;
    _results = [];
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      group = _ref[_i];
      _results.push(group.clearTiles());
    }
    return _results;
  };

  TileTier.prototype.clearTileGroup = function(groupIdx) {
    if (groupIdx >= this.groups.length) {
      return;
    }
    return this.groups[groupIdx].clearTiles();
  };

  TileTier.prototype.addGroup = function(groupTitle, groupPriority) {
    var gpidx, groupId, insertIdx, newTileGroup, _i, _ref;
    groupId = this.groups.length;
    newTileGroup = new TileGroup(this, this.groupTitlesTagLocator, groupId, groupTitle, groupPriority);
    insertIdx = 0;
    for (gpidx = _i = _ref = this.groups.length - 1; _i >= 0; gpidx = _i += -1) {
      if (this.groups[gpidx].groupPriority >= groupPriority) {
        insertIdx = gpidx + 1;
        break;
      }
    }
    this.groups.splice(insertIdx, 0, newTileGroup);
    return insertIdx;
  };

  TileTier.prototype.findGroupIdx = function(groupName) {
    var group, groupIdx, _i, _len, _ref;
    groupIdx = 0;
    _ref = this.groups;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      group = _ref[_i];
      if (group.groupTitle === groupName) {
        return groupIdx;
      }
      groupIdx += 1;
    }
    return -1;
  };

  TileTier.prototype.getTierHeight = function() {
    var tierSel;
    tierSel = $("#" + this.tierId);
    return tierSel[0].clientHeight;
  };

  TileTier.prototype.getTierTop = function() {
    var tierSel;
    tierSel = $("#" + this.tierId);
    return tierSel[0].offsetTop;
  };

  TileTier.prototype.calcLayout = function() {
    var group, isPortrait, winHeight, winWidth, _i, _len, _ref;
    winWidth = $(window).width();
    winHeight = $(window).height();
    isPortrait = winWidth < winHeight;
    this.tilesAcross = isPortrait ? 3 : 5;
    this.tilesDown = isPortrait ? 5 : 3;
    this.cellWidth = (winWidth - (this.groupSepPixels * Math.floor((this.tilesAcross - 1) / 3))) / this.tilesAcross;
    this.cellHeight = (winHeight - this.groupTitlesTopMargin) / this.tilesDown;
    this.tileWidth = this.cellWidth - this.tileSepXPixels;
    this.tileHeight = this.cellHeight - this.tileSepYPixels;
    this.groupCols = [];
    _ref = this.groups;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      group = _ref[_i];
      this.groupCols.push(group.getColsInGroup(this.tilesDown, isPortrait));
    }
    $("#" + this.tierId).css({
      "height": document.documentElement.clientHeight + "px"
    });
    return isPortrait;
  };

  TileTier.prototype.getTileSize = function(colSpan, rowSpan) {
    return [this.tileWidth * colSpan + (this.tileSepXPixels * (colSpan - 1)), this.tileHeight * rowSpan + (this.tileSepYPixels * (rowSpan - 1))];
  };

  TileTier.prototype.getGroupStartX = function(groupIdx) {
    var gIdx, xStart;
    gIdx = 0;
    xStart = 0;
    while (gIdx < groupIdx && gIdx < this.groupCols.length) {
      xStart += this.groupCols[gIdx] * this.cellWidth;
      gIdx += 1;
    }
    xStart += groupIdx * this.groupSepPixels;
    return xStart;
  };

  TileTier.prototype.getGroupColXPositions = function() {
    var cellPos, colIdx, colXPosns, group, groupColXPosns, groupIdx, _i, _j, _len, _ref, _ref1;
    groupColXPosns = [];
    _ref = this.groups;
    for (groupIdx = _i = 0, _len = _ref.length; _i < _len; groupIdx = ++_i) {
      group = _ref[groupIdx];
      colXPosns = [];
      for (colIdx = _j = 0, _ref1 = this.groupCols[groupIdx] - 1; 0 <= _ref1 ? _j <= _ref1 : _j >= _ref1; colIdx = 0 <= _ref1 ? ++_j : --_j) {
        cellPos = this.getCellPos(groupIdx, colIdx, 0);
        colXPosns.push(cellPos[0]);
      }
      groupColXPosns.push(colXPosns);
    }
    return groupColXPosns;
  };

  TileTier.prototype.calcFontSizePercent = function() {
    return 100 * Math.max(this.cellWidth, this.cellHeight) / 300;
  };

  TileTier.prototype.getGroupTitlePos = function(groupIdx) {
    var xStart;
    xStart = this.getGroupStartX(groupIdx);
    return [xStart, 10, "200%"];
  };

  TileTier.prototype.getGroupTitleWidth = function(groupIdx) {
    var xEnd, xStart;
    xStart = this.getGroupStartX(groupIdx);
    xEnd = this.getGroupStartX(groupIdx + 1);
    return xEnd - xStart - this.groupSepPixels;
  };

  TileTier.prototype.getCellPos = function(groupIdx, colIdx, rowIdx) {
    var cellX, cellY, colInGroup, fontScaling, xStart;
    xStart = this.getGroupStartX(groupIdx);
    colInGroup = colIdx;
    cellX = xStart + colInGroup * this.cellWidth;
    cellY = this.groupTitlesTopMargin + rowIdx * this.cellHeight;
    fontScaling = this.calcFontSizePercent();
    return [cellX, cellY, fontScaling];
  };

  TileTier.prototype.getNextTileIdx = function() {
    this.nextTileIdx += 1;
    return this.nextTileIdx;
  };

  TileTier.prototype.addTileToGroup = function(groupIdx, tile) {
    return this.groups[groupIdx].addExistingTile(tile);
  };

  TileTier.prototype.reDoLayout = function() {
    var group, groupIdx, isPortrait, _i, _len, _ref, _results;
    isPortrait = this.calcLayout();
    _ref = this.groups;
    _results = [];
    for (groupIdx = _i = 0, _len = _ref.length; _i < _len; groupIdx = ++_i) {
      group = _ref[groupIdx];
      _results.push(group.repositionTiles(isPortrait, groupIdx));
    }
    return _results;
  };

  TileTier.prototype.findExistingTile = function(tileName, groupName) {
    var existingTile, group, _i, _len, _ref;
    existingTile = null;
    _ref = this.groups;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      group = _ref[_i];
      if ((groupName != null) && groupName !== null) {
        if (group.groupTitle !== groupName) {
          continue;
        }
      }
      existingTile = group.findExistingTile(tileName);
      if (existingTile !== null) {
        break;
      }
    }
    return existingTile;
  };

  TileTier.prototype.getTilesAcrossScreen = function() {
    return this.tilesAcross;
  };

  return TileTier;

})();
