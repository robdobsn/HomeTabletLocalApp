// Generated by CoffeeScript 2.5.1
(function() {
  App.TabletConfigManager = class TabletConfigManager {
    constructor(defaultTabletName, defaultTabletConfigUrl) {
      this.defaultTabletName = defaultTabletName;
      this.defaultTabletConfigUrl = defaultTabletConfigUrl;
      this.configData = {};
      this.defaultTabletConfig = new App.DefaultTabletConfig();
      this.defaultConfigSettings = {
        showCalServerSetting: true,
        showAutomationServerSettings: ["Indigo", "Vera", "Fibaro"],
        showEnergyServerSetting: true
      };
      console.log("tablet-config constructed with defaults defaultTabletName " + this.defaultTabletName);
      return;
    }

    getTabName() {
      var tabName, tabNameStored;
      // See if the tablet's name is in the local storage
      tabNameStored = App.LocalStorage.get("DeviceConfigName");
      tabName = this.defaultTabletName;
      if ((tabNameStored != null) && tabNameStored !== "") {
        tabName = tabNameStored;
        console.log("tablet-config getTabName from local storage = " + tabName);
      } else {
        console.log("tablet-config getTabName using default " + tabName);
      }
      return tabName;
    }

    getReqUrl() {
      var reqURL, tabName;
      reqURL = this.defaultTabletConfigUrl;
      if ((reqURL == null) || reqURL === "") {
        return "";
      }
      tabName = this.getTabName();
      reqURL = reqURL.trim();
      reqURL = reqURL + (reqURL.slice(-1) === "/" ? "" : "/") + "tabletconfig/" + tabName;
      console.log("tablet-config getReqUrl " + reqURL);
      return reqURL;
    }

    setReadyCallback(readyCallback) {
      this.readyCallback = readyCallback;
    }

    getConfigData() {
      return this.configData;
    }

    addFavouriteButton(buttonInfo) {
      console.log("Add " + buttonInfo.tileName);
      if (!("favourites" in this.configData)) {
        this.configData.favourites = [];
      }
      this.configData.favourites.push({
        tileName: buttonInfo.tileName,
        groupName: buttonInfo.groupName
      });
      return this.saveDeviceConfig();
    }

    deleteFavouriteButton(buttonInfo) {
      var fav, favIdx, i, idx, len, ref;
      console.log("Delete " + buttonInfo.tileName);
      if (!("favourites" in this.configData)) {
        return;
      }
      favIdx = -1;
      ref = this.configData.favourites;
      for (idx = i = 0, len = ref.length; i < len; idx = ++i) {
        fav = ref[idx];
        if (fav.tileName === buttonInfo.tileName && fav.groupName === buttonInfo.groupName) {
          favIdx = idx;
          break;
        }
      }
      if (favIdx >= 0) {
        this.configData.favourites.splice(favIdx, 1);
        return this.saveDeviceConfig();
      }
    }

    saveDeviceConfig() {
      var reqURL, tabName;
      reqURL = this.getReqUrl();
      App.LocalStorage.set(reqURL, this.configData);
      tabName = this.getTabName();
      if ((tabName == null) || tabName === "") {
        console.log("tablet-config Unable to save device config as tablet name unknown");
      } else {
        console.log("tablet-config Saving device config for " + tabName);
      }
      // Store back to the server 
      return $.ajax({
        url: reqURL,
        type: 'POST',
        data: JSON.stringify({
          "favourites": this.configData.favourites
        }),
        contentType: "application/json",
        success: (data, status, response) => {
          return console.log("tablet-config Sent new config data ok");
        },
        error: (jqXHR, textStatus, errorThrown) => {
          return console.error("tablet-config Failed to send new config data: " + textStatus + " " + errorThrown);
        }
      });
    }

    applyStoredData(reqURL) {
      var storedData;
      storedData = App.LocalStorage.get(reqURL);
      console.log("tablet-config Config Getting data stored for " + reqURL + " result = " + storedData);
      if (storedData != null) {
        // console.log "Using stored data" + JSON.stringify(storedData)
        console.log("tablet-config Using stored data for " + reqURL);
        this.configData = storedData;
      } else {
        this.configData = this.defaultTabletConfig.get(this.defaultConfigSettings);
      }
      return this.readyCallback();
    }

    requestConfig() {
      var reqURL, tabName;
      reqURL = this.getReqUrl();
      // Handle no config server situation
      if (reqURL === "") {
        this.configData = this.defaultTabletConfig.get(this.defaultConfigSettings);
        this.readyCallback();
        return;
      }
      // Get the configuration from the server
      tabName = this.getTabName();
      console.log("tablet-config Requesting tablet config from tabname " + this.getTabName() + " using URL " + reqURL);
      // get the tablet config from a server
      this.catchAjaxFail = setTimeout(this.ajaxFailTimeout, 2000);
      $.ajax(reqURL, {
        type: "GET",
        dataType: "text",
        crossDomain: true,
        timeout: 1500,
        success: (data, textStatus, jqXHR) => {
          var curTabName, jsonData, jsonText;
          clearTimeout(this.catchAjaxFail);
          jsonText = jqXHR.responseText;
          jsonData = $.parseJSON(jsonText);
          if (jsonText === "{}") {
            console.log("tablet-config Got tablet config but it's empty");
            this.configData = this.defaultTabletConfig.get(this.defaultConfigSettings);
            this.applyStoredData(reqURL);
          } else {
            // console.log "tablet-config Got tablet config data"
            curTabName = this.getTabName();
            tabName = "deviceName" in jsonData ? jsonData.deviceName : curTabName;
            if ((tabName != null) && tabName !== curTabName) {
              App.LocalStorage.set("DeviceConfigName", tabName);
              console.log("tablet-config DeviceConfigName was " + curTabName + " now set to " + tabName);
              App.LocalStorage.logEvent("CnfLog", "DeviceConfigName was " + curTabName + " now set to " + tabName);
            }
            this.configData = jsonData;
            App.LocalStorage.set(reqURL, this.configData);
            if (("common" in jsonData) && ("servers" in jsonData.common)) {
              console.log("tablet-config got " + tabName + " len " + JSON.stringify(jsonData).length + " #servers " + jsonData.common.servers.length);
            } else {
              console.log("tablet-config got " + tabName + " len " + JSON.stringify(jsonData).length + " NO SERVERS DEFINED");
            }
            if ("deviceName" in jsonData) {
              console.log("tablet-config got " + tabName + " deviceName " + jsonData.deviceName);
            } else {
              console.log("tablet-config got " + tabName + " deviceName NOT PRESENT");
              console.log("");
              console.log(jsonText);
              console.log("");
            }
            if ("roomName" in jsonData) {
              console.log("tablet-config got " + tabName + " roomName " + jsonData.roomName);
            } else {
              console.log("tablet-config got " + tabName + " roomName NOT PRESENT");
            }
            if ("sonosRoomName" in jsonData) {
              console.log("tablet-config got " + tabName + " sonosRoomName " + jsonData.sonosRoomName);
            } else {
              console.log("tablet-config got " + tabName + " sonosRoomName NOT PRESENT");
            }
            this.readyCallback();
          }
        },
        error: (jqXHR, textStatus, errorThrown) => {
          console.log("tablet-config Get tablet config data failed with an error " + textStatus);
          // Use stored data if available
          clearTimeout(this.catchAjaxFail);
          this.applyStoredData(reqURL);
        }
      });
    }

    ajaxFailTimeout() {
      console.log("tablet-config Get tablet config timed out via setTimeout");
      this.configData = this.defaultTabletConfig.get(this.defaultConfigSettings);
      this.readyCallback();
    }

  };

}).call(this);

//# sourceMappingURL=tablet-config.js.map
