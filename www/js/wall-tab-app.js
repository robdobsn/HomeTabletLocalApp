// Generated by CoffeeScript 1.7.1
var WallTabApp,
  __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

WallTabApp = (function() {
  function WallTabApp() {
    this.navigateTo = __bind(this.navigateTo, this);
    this.scrollStopDelayed = __bind(this.scrollStopDelayed, this);
    this.scrollStop = __bind(this.scrollStop, this);
    this.scrollStart = __bind(this.scrollStart, this);
    this.actionOnUserIdle = __bind(this.actionOnUserIdle, this);
    this.automationServerReadyCb = __bind(this.automationServerReadyCb, this);
    this.configReadyCb = __bind(this.configReadyCb, this);
    this.rebuildUI = __bind(this.rebuildUI, this);
    this.tileColours = new TileColours;
    this.rdHomeServerUrl = "http://macallan:5000";
    this.calendarUrl = this.rdHomeServerUrl + "/calendars/api/v1.0/cal";
    this.automationActionsUrl = this.rdHomeServerUrl + "/automation/api/v1.0/actions";
    this.automationExecUrl = this.rdHomeServerUrl;
    this.sonosActionsUrl = this.rdHomeServerUrl + "/sonos/api/v1.0/actions";
    this.tabletConfigUrl = this.rdHomeServerUrl + "/tablet/api/v1.0/config";
    this.indigoServerUrl = "http://IndigoServer.local:8176";
    this.fibaroServerUrl = "http://192.168.0.69";
    this.veraServerUrl = "http://192.168.0.206:3480";
    this.jsonConfig = {};
    this.mediaPlayHelper = new MediaPlayHelper({
      click: "assets/click.mp3",
      ok: "assets/blip.mp3",
      fail: "assets/fail.mp3"
    });
    this.lastScrollEventTime = 0;
    this.minTimeBetweenScrolls = 1000;
    this.hoursBetweenActionUpdates = 12;
  }

  WallTabApp.prototype.go = function() {
    $("body").prepend("<div id=\"sqWrapper\">\n</div>");
    this.userIdleCatcher = new UserIdleCatcher(30, this.actionOnUserIdle);
    this.setDefaultTabletConfig();
    this.automationActionGroups = [];
    this.automationServer = new AutomationServer(this.automationActionsUrl, this.automationExecUrl, this.veraServerUrl, this.indigoServerUrl, this.fibaroServerUrl, this.sonosActionsUrl, this.mediaPlayHelper, this.navigateTo);
    this.automationServer.setReadyCallback(this.automationServerReadyCb);
    this.tabletConfig = new TabletConfig(this.tabletConfigUrl);
    this.tabletConfig.setReadyCallback(this.configReadyCb);
    this.tileTiers = new TileTiers("#sqWrapper");
    $(window).on('orientationchange', (function(_this) {
      return function() {
        return _this.tileTiers.reDoLayout();
      };
    })(this));
    $(window).on('resize', (function(_this) {
      return function() {
        return _this.tileTiers.reDoLayout();
      };
    })(this));
    $(window).on('scrollstart', (function(_this) {
      return function() {
        return _this.scrollStart();
      };
    })(this));
    $(window).on('scrollstop', (function(_this) {
      return function() {
        return _this.scrollStop();
      };
    })(this));
    this.rebuildUI();
    this.requestActionAndConfigData();
    return setInterval((function(_this) {
      return function() {
        return _this.requestActionAndConfigData();
      };
    })(this), this.hoursBetweenActionUpdates * 60 * 60 * 1000);
  };

  WallTabApp.prototype.requestActionAndConfigData = function() {
    this.automationServer.getActionGroups();
    return this.tabletConfig.initTabletConfig();
  };

  WallTabApp.prototype.setDefaultTabletConfig = function() {
    var groupDefinitions, tileDefinitions;
    groupDefinitions = [
      {
        tierName: "mainTier",
        groupName: "Home"
      }, {
        tierName: "mainTier",
        groupName: "Calendar"
      }, {
        tierName: "actionsTier",
        groupName: "Lights"
      }, {
        tierName: "sonosTier",
        groupName: "Sonos"
      }, {
        tierName: "sonosTier",
        groupName: "Kids"
      }, {
        tierName: "doorBlindsTier",
        groupName: "Front Door"
      }, {
        tierName: "calendarTier",
        groupName: "Today"
      }
    ];
    this.jsonConfig["groupDefinitions"] = groupDefinitions;
    tileDefinitions = [
      {
        tierName: "mainTier",
        groupName: "Calendar",
        colSpan: 2,
        rowSpan: 2,
        uri: "~~~calendarTier",
        name: "calendar",
        visibility: "landscape",
        tileType: "calendar",
        iconName: "none",
        calDayIndex: 0
      }, {
        tierName: "mainTier",
        groupName: "Home",
        colSpan: 3,
        rowSpan: 1,
        uri: "~~~calendarTier",
        name: "calendar",
        visibility: "portrait",
        tileType: "calendar",
        iconName: "none",
        calDayIndex: 0
      }, {
        tierName: "calendarTier",
        groupName: "Today",
        colSpan: 2,
        rowSpan: 3,
        uri: "",
        name: "calendar",
        visibility: "landscape",
        tileType: "calendar",
        iconName: "none",
        calDayIndex: 0
      }, {
        tierName: "calendarTier",
        groupName: "Tomorrow",
        colSpan: 2,
        rowSpan: 3,
        uri: "",
        name: "calendar",
        visibility: "landscape",
        tileType: "calendar",
        iconName: "none",
        calDayIndex: 1
      }, {
        tierName: "calendarTier",
        groupName: "Today + 2",
        colSpan: 2,
        rowSpan: 3,
        uri: "",
        name: "calendar",
        visibility: "landscape",
        tileType: "calendar",
        iconName: "none",
        calDayIndex: 2
      }, {
        tierName: "calendarTier",
        groupName: "Today + 3",
        colSpan: 2,
        rowSpan: 3,
        uri: "",
        name: "calendar",
        visibility: "landscape",
        tileType: "calendar",
        iconName: "none",
        calDayIndex: 3
      }, {
        tierName: "calendarTier",
        groupName: "Today + 4",
        colSpan: 2,
        rowSpan: 3,
        uri: "",
        name: "calendar",
        visibility: "landscape",
        tileType: "calendar",
        iconName: "none",
        calDayIndex: 4
      }, {
        tierName: "calendarTier",
        groupName: "Today",
        colSpan: 3,
        rowSpan: 5,
        uri: "",
        name: "calendar",
        visibility: "portrait",
        tileType: "calendar",
        iconName: "none",
        calDayIndex: 0
      }, {
        tierName: "calendarTier",
        groupName: "Tomorrow",
        colSpan: 3,
        rowSpan: 5,
        uri: "",
        name: "calendar",
        visibility: "portrait",
        tileType: "calendar",
        iconName: "none",
        calDayIndex: 1
      }, {
        tierName: "calendarTier",
        groupName: "Today + 2",
        colSpan: 3,
        rowSpan: 5,
        uri: "",
        name: "calendar",
        visibility: "portrait",
        tileType: "calendar",
        iconName: "none",
        calDayIndex: 2
      }, {
        tierName: "calendarTier",
        groupName: "Today + 3",
        colSpan: 3,
        rowSpan: 5,
        uri: "",
        name: "calendar",
        visibility: "portrait",
        tileType: "calendar",
        iconName: "none",
        calDayIndex: 3
      }, {
        tierName: "calendarTier",
        groupName: "Today + 4",
        colSpan: 3,
        rowSpan: 5,
        uri: "",
        name: "calendar",
        visibility: "portrait",
        tileType: "calendar",
        iconName: "none",
        calDayIndex: 4
      }, {
        tierName: "mainTier",
        groupName: "Calendar",
        colSpan: 2,
        rowSpan: 1,
        uri: "",
        name: "clock",
        visibility: "landscape",
        tileType: "clock",
        iconName: "none"
      }, {
        tierName: "mainTier",
        groupName: "Home",
        colSpan: 3,
        rowSpan: 1,
        uri: "",
        name: "clock",
        visibility: "portrait",
        tileType: "clock",
        iconName: "none"
      }
    ];
    return this.jsonConfig["tileDefinitions"] = tileDefinitions;
  };

  WallTabApp.prototype.makeTileFromTileDef = function(tileDef) {
    if (tileDef.tileType === "calendar") {
      return this.makeCalendarTile(tileDef);
    } else if (tileDef.tileType === "clock") {
      return this.makeClockTile(tileDef);
    } else {
      return this.makeSceneTile(tileDef);
    }
  };

  WallTabApp.prototype.tileBasicsFromDef = function(tileDef) {
    var isFavourite, tierIdx, tileBasics, tileColour;
    tileColour = this.tileColours.getNextColour();
    tierIdx = this.tileTiers.findTierIdx(tileDef.tierName);
    if (tierIdx < 0) {
      return null;
    }
    if ((tileDef.isFavourite != null) && tileDef.isFavourite) {
      isFavourite = true;
    }
    return tileBasics = new TileBasics(tileColour, tileDef.colSpan, tileDef.rowSpan, this.automationServer.executeCommand, tileDef.uri, tileDef.name, tileDef.visibility, this.tileTiers.getTileTierSelector(tileDef.tierName), tileDef.tileType, tileDef.iconName, isFavourite, this.mediaPlayHelper);
  };

  WallTabApp.prototype.makeCalendarTile = function(tileDef) {
    var tile, tileBasics;
    tileBasics = this.tileBasicsFromDef(tileDef);
    if (tileBasics === null) {
      return;
    }
    tile = new CalendarTile(tileBasics, this.calendarUrl, tileDef.calDayIndex);
    return this.addTileToTierGroup(tileDef.tierName, tileDef.groupName, tile);
  };

  WallTabApp.prototype.makeClockTile = function(tileDef) {
    var tile, tileBasics;
    tileBasics = this.tileBasicsFromDef(tileDef);
    if (tileBasics === null) {
      return;
    }
    tile = new Clock(tileBasics);
    return this.addTileToTierGroup(tileDef.tierName, tileDef.groupName, tile);
  };

  WallTabApp.prototype.makeSceneTile = function(tileDef) {
    var tile, tileBasics;
    tileBasics = this.tileBasicsFromDef(tileDef);
    if (tileBasics === null) {
      return;
    }
    tile = new SceneButton(tileBasics, tileDef.name);
    return this.addTileToTierGroup(tileDef.tierName, tileDef.groupName, tile);
  };

  WallTabApp.prototype.addTileToTierGroup = function(tierName, groupName, tile) {
    var groupIdx, tierIdx;
    tierIdx = this.tileTiers.findTierIdx(tierName);
    if (tierIdx < 0) {
      tierIdx = this.tileTiers.findTierIdx("actionsTier");
    }
    if (tierIdx < 0) {
      return;
    }
    if (groupName === "") {
      groupName = "Lights";
    }
    groupIdx = this.getUIGroupIdxAddGroupIfReqd(tierIdx, groupName);
    return this.tileTiers.addTileToTierGroup(tierIdx, groupIdx, tile);
  };

  WallTabApp.prototype.rebuildUI = function() {
    var action, actionList, iconName, servType, tierName, tileDef, _i, _len, _ref;
    this.tileTiers.removeAll();
    this.applyTierAndGroupConfig(this.jsonConfig);
    _ref = this.automationActionGroups;
    for (servType in _ref) {
      actionList = _ref[servType];
      for (_i = 0, _len = actionList.length; _i < _len; _i++) {
        action = actionList[_i];
        tierName = "tierName" in action ? action.tierName : "actionsTier";
        iconName = "iconName" in action ? action.iconName : "bulb-on";
        tileDef = {
          tierName: tierName,
          groupName: action.groupName,
          colSpan: 1,
          rowSpan: 1,
          uri: action.actionUrl,
          name: action.actionName,
          visibility: "all",
          tileType: "action",
          iconName: iconName
        };
        this.makeTileFromTileDef(tileDef);
      }
    }
    this.applyTileConfig(this.jsonConfig);
    return this.tileTiers.reDoLayout();
  };

  WallTabApp.prototype.getUIGroupIdxAddGroupIfReqd = function(tierIdx, groupName) {
    var groupIdx;
    if (groupName === "") {
      return -1;
    }
    groupIdx = this.tileTiers.findGroupIdx(tierIdx, groupName);
    if (groupIdx < 0) {
      groupIdx = this.tileTiers.addGroup(tierIdx, groupName);
    }
    return groupIdx;
  };

  WallTabApp.prototype.applyTierAndGroupConfig = function(jsonConfig) {
    var groupDef, groupIdx, newTier, tierIdx, _i, _len, _ref, _results;
    _ref = jsonConfig.groupDefinitions;
    _results = [];
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      groupDef = _ref[_i];
      tierIdx = this.tileTiers.findTierIdx(groupDef.tierName);
      if (tierIdx < 0) {
        newTier = new TileTier("#sqWrapper", groupDef.tierName);
        newTier.addToDom();
        tierIdx = this.tileTiers.addTier(newTier);
      }
      _results.push(groupIdx = this.getUIGroupIdxAddGroupIfReqd(tierIdx, groupDef.groupName));
    }
    return _results;
  };

  WallTabApp.prototype.applyTileConfig = function(jsonConfig) {
    var destGroupName, exTile, favouriteDefn, tb, tileDef, _i, _j, _len, _len1, _ref, _ref1;
    if ("tileDefinitions" in jsonConfig) {
      _ref = jsonConfig.tileDefinitions;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        tileDef = _ref[_i];
        this.makeTileFromTileDef(tileDef);
      }
    }
    if ("favourites" in jsonConfig) {
      _ref1 = jsonConfig.favourites;
      for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
        favouriteDefn = _ref1[_j];
        exTile = this.tileTiers.findExistingTile(favouriteDefn.tileName, favouriteDefn.groupName);
        if (exTile !== null) {
          tb = exTile.tileBasics;
          destGroupName = "destGroup" in favouriteDefn ? favouriteDefn["destGroup"] : "Home";
          tileDef = {
            tierName: "mainTier",
            groupName: destGroupName,
            colSpan: tb.colSpan,
            rowSpan: tb.rowSpan,
            uri: tb.clickParam,
            name: tb.tileName,
            visibility: tb.visibility,
            tileType: tb.tileType,
            iconName: tb.iconName,
            isFavourite: true
          };
          this.makeTileFromTileDef(tileDef);
        }
      }
    }
  };

  WallTabApp.prototype.configReadyCb = function(inConfig) {
    var k, v;
    for (k in inConfig) {
      v = inConfig[k];
      this.jsonConfig[k] = v;
    }
    return this.rebuildUI();
  };

  WallTabApp.prototype.automationServerReadyCb = function(actions, serverType) {
    if (this.checkActionGroupsChanged(this.automationActionGroups, actions)) {
      this.automationActionGroups = actions;
      return this.rebuildUI();
    }
  };

  WallTabApp.prototype.checkActionGroupsChanged = function(oldActionMap, newActionMap) {
    var newActions, oldActions, servType;
    if (Object.keys(oldActionMap).length !== Object.keys(newActionMap).length) {
      return true;
    }
    for (servType in oldActionMap) {
      oldActions = oldActionMap[servType];
      if (!(servType in newActionMap)) {
        return true;
      }
      newActions = newActionMap[servType];
      if (this.checkActionsForServer(oldActions, newActions)) {
        return true;
      }
    }
    return false;
  };

  WallTabApp.prototype.checkActionsForServer = function(oldActions, newActions) {
    var j, k, newAction, oldAction, v, _i, _len;
    if (oldActions.length !== newActions.length) {
      return true;
    }
    for (j = _i = 0, _len = oldActions.length; _i < _len; j = ++_i) {
      oldAction = oldActions[j];
      newAction = newActions[j];
      if (Object.keys(oldAction).length !== Object.keys(newAction).length) {
        return true;
      }
      for (k in oldAction) {
        v = oldAction[k];
        if (!k in newAction) {
          return true;
        }
        if (v !== newAction[k]) {
          return true;
        }
      }
    }
    return false;
  };

  WallTabApp.prototype.actionOnUserIdle = function() {
    if ($(window).scrollLeft() === 0 && $(window).scrollTop() === 0) {
      return;
    }
    return $("html, body").animate({
      scrollLeft: "0px"
    }, 200).animate({
      scrollUp: "0px"
    }, 200);
  };

  WallTabApp.prototype.scrollStart = function() {
    this.scrollCurTop = $(window).scrollTop();
    this.scrollCurLeft = $(window).scrollLeft();
    return console.log("Scrollstart " + this.scrollCurLeft + ", " + this.scrollCurTop);
  };

  WallTabApp.prototype.scrollStop = function() {
    if (this.scrollStopTimer != null) {
      clearTimeout(this.scrollStopTimer);
    }
    return this.scrollStopTimer = setTimeout((function(_this) {
      return function() {
        return _this.scrollStopDelayed();
      };
    })(this), 2000);
  };

  WallTabApp.prototype.scrollStopDelayed = function() {
    var bestColX, bestGroupIdx, colX, gpIdx, groupColXPos, groupColXPosns, minScrollYForWholeTier, scrollDistX, scrollDistY, scrollLeft, scrollToX, scrollToY, scrollTop, tierHeight, tierIdx, tilesAcrossScreen, _i, _j, _len, _len1, _ref;
    if (this.lastScrollEventTime + this.minTimeBetweenScrolls > new Date().getTime()) {
      console.log("scrollstop ignored");
      return;
    }
    console.log("Scrollstop " + $(window).scrollLeft() + ", " + $(window).scrollTop());
    this.lastScrollEventTime = new Date().getTime();
    if (this.tileTiers.numTiers() <= 1) {
      return;
    }
    tierHeight = this.tileTiers.getTier(1).getTierTop();
    minScrollYForWholeTier = 50;
    scrollTop = $(window).scrollTop();
    scrollLeft = $(window).scrollLeft();
    scrollDistY = scrollTop - this.scrollCurTop;
    scrollDistX = scrollLeft - this.scrollCurLeft;
    if (Math.abs(scrollDistY) > minScrollYForWholeTier && Math.abs(scrollDistY) < tierHeight) {
      scrollDistY = scrollDistY > 0 ? tierHeight : -tierHeight;
    }
    scrollToY = Math.round((this.scrollCurTop + scrollDistY) / tierHeight) * tierHeight;
    tierIdx = scrollToY / tierHeight;
    if (tierIdx >= this.tileTiers.numTiers()) {
      tierIdx = this.tileTiers.numTiers() - 1;
    }
    groupColXPosns = this.tileTiers.getGroupColXPositions(tierIdx);
    scrollToX = this.scrollCurLeft + scrollDistX;
    bestGroupIdx = 0;
    for (gpIdx = _i = 0, _len = groupColXPosns.length; _i < _len; gpIdx = ++_i) {
      groupColXPos = groupColXPosns[gpIdx];
      if (scrollToX < groupColXPos[0]) {
        if (scrollDistX < 0 && gpIdx >= 1) {
          bestGroupIdx = gpIdx - 1;
        }
        break;
      }
      bestGroupIdx = gpIdx;
    }
    tilesAcrossScreen = this.tileTiers.getTilesAcrossScreen();
    if (groupColXPosns[bestGroupIdx].length > tilesAcrossScreen) {
      bestColX = 0;
      _ref = groupColXPosns[bestGroupIdx];
      for (_j = 0, _len1 = _ref.length; _j < _len1; _j++) {
        colX = _ref[_j];
        if (scrollToX < colX) {
          scrollToX = bestColX;
          break;
        }
        bestColX = colX;
      }
    } else {
      scrollToX = groupColXPosns[bestGroupIdx][0];
    }
    console.log("scroll animating " + this.scrollCurLeft + ", " + this.scrollCurTop + ", " + scrollDistX + ", " + scrollDistY + " TH " + tierHeight + " STX " + scrollToX + " STY " + scrollToY);
    if (scrollToX === scrollLeft) {
      if (scrollToY === scrollTop) {
        return;
      }
      $("html, body").stop().animate({
        scrollTop: scrollToY
      }, 200);
      return;
    }
    if (scrollToY === scrollTop) {
      $("html, body").stop().animate({
        scrollLeft: scrollToX
      }, 200);
      return;
    }
    return $("html, body").stop().animate({
      scrollLeft: scrollToX
    }, 200).animate({
      scrollTop: scrollToY
    }, 200);
  };

  WallTabApp.prototype.navigateTo = function(tierName) {
    var tierTop;
    tierTop = this.tileTiers.getTierTop(tierName);
    if (tierTop >= 0) {
      return $("html, body").stop().animate({
        scrollTop: tierTop
      }, 200);
    }
  };

  return WallTabApp;

})();
