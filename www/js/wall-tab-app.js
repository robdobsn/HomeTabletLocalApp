// Generated by CoffeeScript 2.5.1
(function() {
  App.WallTabApp = class WallTabApp {
    constructor() {
      this.tabletConfigReadyCb = this.tabletConfigReadyCb.bind(this);
      this.automationManagerReadyCb = this.automationManagerReadyCb.bind(this);
      this.VERSION = "2.2.0";
      console.log("wall-tab-app APPLICATION STARTING UP " + this.VERSION);
      // Default the tablet name and get the configuration server
      this.defaultTabletName = "tabhall";
      this.defaultConfigServerUrl = "http://192.168.86.247:5076";
      // Basic settings
      this.hoursBetweenActionUpdates = 12;
      this.minsBetweenEventLogChecks = 1;
      this.maxEventsPerLogSend = 50;
      // Helper for playing media files
      this.mediaPlayHelper = new App.MediaPlayHelper({
        "click": "assets/click.mp3",
        "ok": "assets/ok.mp3",
        "fail": "assets/fail-wah.mp3"
      });
      this.tileColours = new App.TileColours();
      return;
    }

    getConfigServerUrl() {
      var configUrl;
      configUrl = App.LocalStorage.get("ConfigServerUrl");
      if (!(configUrl != null) || (configUrl.length === 0)) {
        console.log("wall-tab-app App.getConfigServerUrl from localstorage empty so using " + this.defaultConfigServerUrl);
        configUrl = this.defaultConfigServerUrl;
      }
      return configUrl;
    }

    getLogServerUrl() {
      return this.getConfigServerUrl() + "/log";
    }

    go() {
      // Goes back to home display after user idle timeout
      this.userIdleCatcher = new App.UserIdleCatcher(90, this.actionOnUserIdle, this);
      // Tablet config is based on the name or IP address of the tablet
      this.tabletConfigManager = new App.TabletConfigManager(this.defaultTabletName, this.defaultConfigServerUrl);
      this.tabletConfigManager.setReadyCallback(this.tabletConfigReadyCb);
      // App updater
      this.appUpdater = new App.AppUpdater(this, this.getConfigServerUrl() + "/deployota/WallTabletApp");
      // Automation manager handles communicaton with automaion devices like
      // Indigo/vera/fibaro
      this.automationManager = new App.AutomationManager(this, this.automationManagerReadyCb);
      // Calendar server communications
      this.calendarManager = new App.CalendarManager(this);
      // App Pages
      this.appPages = new App.AppPages(this, "#sqWrapper", this.automationManager, this.VERSION);
      // Handler for orientation change
      $(window).on('orientationchange', () => {
        return this.buildAndDisplayUI();
      });
      // And resize event
      $(window).on('resize', () => {
        return this.buildAndDisplayUI();
      });
      // Check event logs frequently
      this.checkEventLogs();
      setInterval(() => {
        return this.checkEventLogs();
      }, this.minsBetweenEventLogChecks * 60 * 1000);
      // Make initial requests for action (scene) data and config data and repeat requests at intervals
      this.requestConfigData();
      setInterval(() => {
        return this.requestConfigData();
      }, this.hoursBetweenActionUpdates * 60 * 60 * 1000);
    }

    requestConfigData() {
      // Request tablet configuration from config server
      return this.tabletConfigManager.requestConfig();
    }

    tabletConfigReadyCb() {
      var configData;
      // Configuration data is available
      configData = this.tabletConfigManager.getConfigData();
      if ((configData.common != null) && (configData.common.calendar != null)) {
        this.calendarManager.setConfig(configData.common.calendar);
      }
      this.automationManager.requestUpdate(configData);
    }

    automationManagerReadyCb(hasChanged) {
      // Automation server data is available
      if (hasChanged) {
        this.buildAndDisplayUI();
      }
    }

    buildAndDisplayUI() {
      this.appPages.build(this.automationManager.getActionGroups());
      this.appPages.display();
    }

    actionOnUserIdle(appObject) {
      console.log("wall-tab-app actionOnUserIdle @appPages " + appObject);
      appObject.appPages.userIsIdle();
    }

    checkEventLogs() {
      var ev, evList, evListJson, i, j, k, len, logCat, logCats, ref;
      evList = [];
      logCats = ["CalLog", "IndLog", "CnfLog"];
      for (j = 0, len = logCats.length; j < len; j++) {
        logCat = logCats[j];
        for (i = k = 0, ref = this.maxEventsPerLogSend; (0 <= ref ? k < ref : k > ref); i = 0 <= ref ? ++k : --k) {
          ev = App.LocalStorage.getEvent(logCat);
          if (ev != null) {
            console.log("wall-tab-app Logging event from " + logCat + " = " + JSON.stringify(ev));
            evList.push({
              logCat: logCat,
              timestamp: ev.timestamp,
              eventText: ev.eventText
            });
          } else {
            break;
          }
        }
      }
      if (evList.length > 0) {
        evListJson = JSON.stringify(evList);
        console.log("wall-tab-app Sending " + evList.length + " log event(s) to log server");
        $.ajax({
          url: this.getLogServerUrl(),
          type: 'POST',
          data: evListJson,
          contentType: "application/json",
          success: (data, status, response) => {
            console.log("wall-tab-app logged events success");
          },
          error: (jqXHR, textStatus, errorThrown) => {
            var l, len1;
            console.log("wall-tab-app Error log failed: " + textStatus + " " + errorThrown);
// If logging failed then re-log the events
            for (l = 0, len1 = evList.length; l < len1; l++) {
              ev = evList[l];
              App.LocalStorage.logEvent(ev.logCat, ev.eventText, ev.timestamp);
            }
          }
        });
      }
    }

    appUpdate() {
      console.log("wall-tab-app App update requested");
      this.appUpdater.appUpdate();
    }

  };

}).call(this);

//# sourceMappingURL=wall-tab-app.js.map
